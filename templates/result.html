<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glucose Prediction Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0d6efd;
            margin-bottom: 30px;
        }
        .prediction-value {
            font-size: 3rem;
            font-weight: bold;
            color: #0d6efd;
            text-align: center;
            margin: 20px 0;
        }
        .recommendation {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #0d6efd;
        }
        .normal-range {
            background-color: rgba(25, 135, 84, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 5px solid #198754;
        }
        .confidence-interval {
            background-color: rgba(13, 110, 253, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 5px solid #0d6efd;
            text-align: center;
        }
        .btn-primary {
            margin-top: 20px;
            width: 100%;
            padding: 10px;
        }
        .info-card {
            margin-bottom: 20px;
        }
        .glucose-gauge-container {
            position: relative;
            width: 100%;
            height: 30px;
            background-color: #e9ecef;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }
        .glucose-gauge {
            height: 100%;
            background: linear-gradient(90deg, #198754, #ffc107, #dc3545);
            border-radius: 15px;
            position: relative;
        }
        .gauge-marker {
            position: absolute;
            width: 4px;
            height: 30px;
            background-color: black;
            top: 0;
            transform: translateX(-2px);
        }
        .accuracy-badge {
            background-color: #0d6efd;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
        }
        .chart-container {
            margin-top: 30px;
            margin-bottom: 20px;
            height: 300px;
        }
        .chart-error {
            padding: 30px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        .range-indicator {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
        .range-bar {
            flex-grow: 1;
            height: 10px;
            background-color: rgba(13, 110, 253, 0.2);
            border-radius: 5px;
            position: relative;
        }
        .range-point {
            position: absolute;
            top: -5px;
            width: 20px;
            height: 20px;
            background-color: #0d6efd;
            border-radius: 50%;
            transform: translateX(-50%);
        }
        .range-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .confidence-text {
            margin-top: 10px;
            color: #0d6efd;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Your Glucose Prediction</h1>
        
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Predicted Blood Glucose Level after 2 hours</h5>
                        <div class="prediction-value">{{ result.prediction }} mg/dL</div>
                        
                        <div class="accuracy-badge">
                            Enhanced Prediction Accuracy: {{ result.accuracy }}%
                        </div>
                        
                        <div class="confidence-interval">
                            <strong>95% Confidence Interval:</strong>
                            <div class="range-indicator">
                                <span class="range-label">{{ result.expected_range_low }}</span>
                                <div class="range-bar">
                                    <div class="range-point" style="left: 50%;"></div>
                                </div>
                                <span class="range-label">{{ result.expected_range_high }}</span>
                            </div>
                            <div class="confidence-text">
                                We are 95% confident your actual glucose will be between
                                {{ result.expected_range_low }} and {{ result.expected_range_high }} mg/dL
                            </div>
                        </div>
                        
                        <div class="glucose-gauge-container">
                            <div class="glucose-gauge" style="width: 100%;"></div>
                            {% if result.is_diabetic == "Yes" %}
                                <!-- Diabetic target ranges -->
                                <div class="gauge-marker" style="left: calc(70px * 100% / 300px);"></div>
                                <div class="gauge-marker" style="left: calc(180px * 100% / 300px);"></div>
                            {% else %}
                                <!-- Non-diabetic target ranges -->
                                <div class="gauge-marker" style="left: calc(70px * 100% / 300px);"></div>
                                <div class="gauge-marker" style="left: calc(140px * 100% / 300px);"></div>
                            {% endif %}
                            
                            <!-- Current prediction marker -->
                            <div class="gauge-marker" style="left: calc({{ result.prediction }}px * 100% / 300px); background-color: #0d6efd; width: 6px;"></div>
                            
                            <!-- Confidence interval markers -->
                            <div class="gauge-marker" style="left: calc({{ result.expected_range_low }}px * 100% / 300px); background-color: rgba(13, 110, 253, 0.5); width: 3px;"></div>
                            <div class="gauge-marker" style="left: calc({{ result.expected_range_high }}px * 100% / 300px); background-color: rgba(13, 110, 253, 0.5); width: 3px;"></div>
                        </div>
                        
                        {% if result.is_diabetic == "Yes" %}
                            <div class="normal-range">
                                <strong>Target range for diabetic individuals:</strong> 70-180 mg/dL (post-meal)
                            </div>
                        {% else %}
                            <div class="normal-range">
                                <strong>Normal range for non-diabetic individuals:</strong> 70-140 mg/dL (post-meal)
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Add glucose prediction graph -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Glucose Prediction Chart</h5>
                        <div class="chart-container">
                            <canvas id="glucoseChart"></canvas>
                        </div>
                        <div id="chartError" class="chart-error">
                            Unable to display chart. Please try again.
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title">Diabetes Status</h5>
                                <p class="card-text">{{ result.is_diabetic }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title">Meal Type</h5>
                                <p class="card-text">{{ result.meal_type }} ({{ result.carbs }}g carbs)</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="recommendation">
                    <h5>Enhanced Personalized Recommendation</h5>
                    <p>{{ result.message }}</p>
                </div>
                
                <a href="/" class="btn btn-primary">Try Another Prediction</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js code for glucose prediction visualization -->
    <script>
        // Wrap in try-catch to prevent JS errors from breaking the page
        try {
            // Get the chart canvas element
            const ctx = document.getElementById('glucoseChart').getContext('2d');
            
            // Current time 
            const now = new Date();
            
            // Create labels for every 30 minutes for 2 hours
            const labels = [];
            const data = [];
            const upperBound = [];
            const lowerBound = [];
            
            // Get values with fallbacks
            const startGlucose = {{ result.current_glucose|default(100, true) }};
            const endGlucose = {{ result.prediction|default(120, true) }};
            const lowerRange = {{ result.expected_range_low|default(100, true) }};
            const upperRange = {{ result.expected_range_high|default(140, true) }};
            
            // Validate values to prevent JavaScript errors
            if (isNaN(startGlucose) || isNaN(endGlucose)) {
                throw new Error("Invalid glucose values");
            }
            
            // Calculate confidence interval width
            const intervalWidth = (upperRange - lowerRange) / 2;
            
            // Create a smooth curve from current to predicted glucose
            for (let i = 0; i <= 8; i++) {
                // Calculate time (now + i*15 minutes)
                const time = new Date(now.getTime() + i * 15 * 60000);
                const timeLabel = time.getHours() + ':' + (time.getMinutes() < 10 ? '0' : '') + time.getMinutes();
                labels.push(timeLabel);
                
                // Calculate progress: 0 at start, 1 at end (2 hours = 8 steps of 15 min)
                const t = i / 8;
                
                // Using cubic ease-in-out function for a more natural curve
                const tc = t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
                const glucose = startGlucose + (endGlucose - startGlucose) * tc;
                
                // Calculate confidence interval - wider in the middle of the prediction
                // Starts narrow, gets wider in the middle, then narrows at the final prediction
                const intervalFactor = 4 * t * (1 - t);  // Parabola that's 0 at t=0 and t=1, peaks at t=0.5
                const currentInterval = intervalWidth * intervalFactor;
                
                data.push(Math.round(glucose));
                upperBound.push(Math.round(glucose + currentInterval));
                lowerBound.push(Math.round(glucose - currentInterval));
            }
            
            // Configure target range line based on diabetic status
            const isDiabetic = "{{ result.is_diabetic }}" === "Yes";
            const upperLimit = isDiabetic ? 180 : 140;
            
            // Create the chart
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Predicted Glucose Level',
                            data: data,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                        },
                        {
                            label: 'Upper Bound (95% CI)',
                            data: upperBound,
                            borderColor: 'rgba(13, 110, 253, 0.3)',
                            borderWidth: 1,
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderDash: [3, 3],
                            fill: '+1',  // Fill to the dataset with index 1 more
                            tension: 0.4,
                            pointRadius: 0,
                        },
                        {
                            label: 'Lower Bound (95% CI)',
                            data: lowerBound,
                            borderColor: 'rgba(13, 110, 253, 0.3)',
                            borderWidth: 1,
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                        },
                        {
                            label: 'Upper Target Limit',
                            data: Array(9).fill(upperLimit),
                            borderColor: '#dc3545',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        },
                        {
                            label: 'Lower Target Limit',
                            data: Array(9).fill(70),
                            borderColor: '#198754',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Glucose (mg/dL)'
                            },
                            min: Math.max(40, Math.min(startGlucose, lowerRange) - 20),
                            max: Math.max(200, Math.max(upperRange, upperLimit) + 20)
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Glucose Prediction Over Time with Confidence Interval'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' mg/dL';
                                }
                            }
                        },
                        legend: {
                            labels: {
                                filter: function(item, chart) {
                                    // Hide lower bound from legend (it's part of the shaded area)
                                    return item.text !== 'Lower Bound (95% CI)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error displaying chart:", error);
            document.getElementById('chartError').style.display = 'block';
            document.querySelector('.chart-container').style.display = 'none';
        }
    </script>
</body>
</html> 